<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Platform · Gantt (wide 2026+)</title>
  <!-- SheetJS, html2canvas, jsPDF, font-awesome (icons) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      background: #f1f5f9;
      font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
      color: #0f172a;
    }
    /* platform at top, no vertical centering */
    .platform {
      max-width: 100%;
      background: white;
      border-radius: 0 0 24px 24px;
      box-shadow: 0 20px 35px -8px rgba(0,0,0,0.15);
      padding: 20px 24px 24px 24px;
      margin: 0 0 20px 0;
    }
    /* header row */
    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 20px;
    }
    .toolbar h2 {
      margin-right: 16px;
      font-weight: 600;
      font-size: 1.6rem;
      background: linear-gradient(145deg, #1e293b, #334155);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    button, .file-label, .import-btn {
      background: white;
      border: 1px solid #cbd5e1;
      border-radius: 40px;
      padding: 8px 18px;
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.02);
      transition: 0.1s ease;
    }
    button:hover, .file-label:hover {
      background: #f8fafc;
      border-color: #94a3b8;
    }
    .btn-primary {
      background: #1e293b;
      color: white;
      border: none;
    }
    .btn-primary:hover {
      background: #0f172a;
    }
    .import-btn {
      background: #f0f9ff;
      border-color: #7ab7e0;
    }

    /* table wrapper – scroll */
    .table-wrapper {
      overflow: auto;
      border: 1px solid #e2e8f0;
      border-radius: 20px;
      background: white;
      max-height: 70vh;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
    }

    table {
      border-collapse: collapse;
      font-size: 12px;
      table-layout: fixed;
      background: white;
      min-width: 100%;
    }

    th, td {
      border-right: 1px solid #e9eef2;
      border-bottom: 1px solid #e9eef2;
      padding: 0 4px;
      height: 24px;                /* dense 24px row */
      line-height: 24px;
      white-space: nowrap;
      background: white;
      vertical-align: middle;
      text-align: left;
    }
    th {
      background: #f8fafc;
      font-weight: 600;
      border-bottom: 2px solid #cbd5e1;
    }

    /* sticky first two columns */
    th:first-child, td:first-child {
      position: sticky;
      left: 0;
      z-index: 10;
      background: white;
      border-right: 2px solid #b9c7da;
    }
    th:nth-child(2), td:nth-child(2) {
      position: sticky;
      left: 90px;                  /* first column width ~90px (see col widths) */
      z-index: 10;
      background: white;
      border-right: 2px solid #b9c7da;
    }
    th:first-child, th:nth-child(2) {
      background: #f0f4fa;
      z-index: 11;
    }

    /* column widths */
    colgroup col.item-col { width: 90px; }      /* item + icons */
    colgroup col.task-col { width: 400px; }
    colgroup col.remark-col { width: 400px; }
    colgroup col.assigned-col,
    colgroup col.start-col,
    colgroup col.due-col,
    colgroup col.duration-col,
    colgroup col.sfdc-col { width: 104px; }     /* +30% wider */
    colgroup col.progress-col { width: 150px; }
    colgroup col.status-col { width: 130px; }
    .week-col { width: 25px; min-width: 25px; max-width: 25px; }

    /* status chips */
    .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 30px;
      font-size: 11px;
      font-weight: 600;
      color: white;
      text-align: center;
      min-width: 80px;
    }
    .status-notstarted { background: #94a3b8; }
    .status-inprogress { background: #2563eb; }
    .status-atrisk     { background: #dc2626; }
    .status-blocked    { background: #ea580c; }
    .status-done       { background: #16a34a; }

    /* progress bar (smooth gradient) */
    .progress-container {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
    }
    .progress-bg {
      background: #e2e8f0;
      border-radius: 30px;
      height: 10px;
      flex: 1;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      border-radius: 30px;
      background: linear-gradient(90deg, #86efac, #15803d);
    }
    .progress-text {
      font-size: 11px;
      min-width: 32px;
    }

    /* Gantt week cell – centered bar */
    .week-cell {
      text-align: center;
      vertical-align: middle;
      padding: 0;
    }
    .gantt-dot {
      display: inline-block;
      width: 18px;
      height: 12px;
      border-radius: 20px;
      background: #2563eb; /* overwritten by style */
    }

    /* month header pastel colors */
    .month-header {
      background: #e0f2fe;  /* base pastel, per month we'll add variation via class */
      font-weight: 600;
      font-size: 11px;
      text-align: center;
      border-right: 1px solid #9bbde0;
      color: #075985;
    }
    .week-label {
      text-align: center;
      font-size: 9px;
      font-weight: 600;
      background: #ecf7ff;
    }
    /* month variations (soft) */
    .month-jan { background: #f1d7fc; } .month-feb { background: #ffe2d6; } .month-mar { background: #d9f0fe; }
    .month-apr { background: #d5f0e3; } .month-may { background: #feeac2; } .month-jun { background: #dae1fc; }
    .month-jul { background: #fcd5d5; } .month-aug { background: #c6ebc9; } .month-sep { background: #fde3cf; }
    .month-oct { background: #d1dafc; } .month-nov { background: #edd6fc; } .month-dec { background: #fed7e2; }

    /* item cell with icons */
    .item-icons {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .item-number {
      font-weight: 600;
      color: #1e293b;
      width: 24px;
      display: inline-block;
    }
    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 15px;
      color: #475569;
      padding: 2px;
    }
    .icon-btn:hover { color: #0f172a; }

    /* editor modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }
    .modal-card {
      background: white;
      border-radius: 32px;
      padding: 28px;
      width: 440px;
      max-width: 96%;
      box-shadow: 0 30px 60px rgba(0,0,0,0.5);
    }
    .modal-card h3 {
      margin-bottom: 20px;
      font-weight: 600;
    }
    .modal-card input, .modal-card select, .modal-card textarea {
      width: 100%;
      padding: 10px 14px;
      margin-bottom: 14px;
      border: 1px solid #cbd5e1;
      border-radius: 30px;
      font-size: 13px;
    }
    .modal-card textarea { border-radius: 20px; }
    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
<div class="platform">
  <div class="toolbar">
    <h2><i class="fas fa-tasks" style="margin-right: 6px;"></i>Platform · Gantt</h2>
    <button class="btn-primary" id="addTaskBtn"><i class="fas fa-plus-circle"></i> Add task</button>
    <button id="exportExcelBtn"><i class="fas fa-file-excel"></i> Export XLSX</button>
    <button id="exportPDFBtn"><i class="fas fa-file-pdf"></i> Export PDF</button>
    <label for="importFile" class="file-label"><i class="fas fa-upload"></i> Import Excel/CSV</label>
    <input type="file" id="importFile" accept=".xlsx,.xls,.csv" style="display:none;">
    <span style="margin-left:auto; color:#475569;"><i class="far fa-save"></i> autosave</span>
  </div>

  <!-- Gantt table wrapper -->
  <div class="table-wrapper" id="ganttWrapper">
    <table id="ganttTable">
      <colgroup>
        <col class="item-col">
        <col class="task-col">
        <col class="sfdc-col">      <!-- we map SFDC as column after task? we reorder: keep SFDC near assigned -->
        <col class="remark-col">
        <col class="assigned-col">
        <col class="start-col">
        <col class="due-col">
        <col class="duration-col">
        <col class="progress-col">
        <col class="status-col">
        <!-- week columns will be appended by js -->
      </colgroup>
      <thead id="tableHeader"></thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

<!-- modal editor -->
<div id="editorModal" class="modal">
  <div class="modal-card">
    <h3 id="modalTitle">➕ New task</h3>
    <input type="text" id="editTask" placeholder="Task name" autocomplete="off">
    <input type="text" id="editSFDC" placeholder="SFDC link (text)">
    <textarea id="editRemark" placeholder="Remark" rows="2"></textarea>
    <input type="text" id="editAssigned" placeholder="Assigned">
    <div style="display:flex; gap:8px;">
      <input type="date" id="editStart" style="flex:1;">
      <input type="date" id="editDue" style="flex:1;">
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <input type="number" id="editProgress" min="0" max="100" placeholder="% progress" style="flex:2;">
      <select id="editStatus" style="flex:3;">
        <option value="Not Started">Not Started</option>
        <option value="In Progress">In Progress</option>
        <option value="At Risk">At Risk</option>
        <option value="Blocked">Blocked</option>
        <option value="Done">Done</option>
      </select>
    </div>
    <div class="modal-actions">
      <button id="modalDelete" style="background:#fee2e2; border:1px solid #fecaca; border-radius:40px; padding:6px 16px;"><i class="fas fa-trash-alt"></i> Delete</button>
      <button id="modalCancel" style="background:white; border:1px solid #cbd5e1; border-radius:40px; padding:6px 16px;">Cancel</button>
      <button id="modalSave" style="background:#1e293b; color:white; border:none; border-radius:40px; padding:6px 20px;">Save</button>
    </div>
  </div>
</div>

<script>
(function() {
  // ---------- DATA ----------
  let tasks = [];
  const STORAGE_KEY = 'gantt_platform_final';

  // load from localStorage
  function loadTasks() {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored) try { tasks = JSON.parse(stored); } catch { tasks = []; }
    if (!tasks.length) {
      // seed one demo task for 2026 to show wide timeline
      const d = new Date();
      tasks.push({
        id: Date.now(),
        task: 'Design review',
        sfdc: 'https://sfdc.com/001',
        remark: 'kickoff Q1',
        assigned: 'Alex',
        start: '2026-02-10',
        due: '2026-04-15',
        progress: 35,
        status: 'In Progress'
      });
    }
    tasks.forEach((t, idx) => { if (!t.id) t.id = Date.now() + idx; });
  }
  function saveTasks() { localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks)); renderAll(); }

  // ---------- date helpers (monday weeks, iso) ----------
  function getMonday(date) {
    const d = new Date(date);
    d.setHours(0,0,0,0);
    const day = d.getDay(); // 0 sun .. 6 sat
    const diff = (day === 0 ? -6 : 1 - day);
    d.setDate(d.getDate() + diff);
    return d;
  }
  function getWeekNumber(d) {
    const date = new Date(d);
    date.setHours(0,0,0,0);
    const day = date.getDay();
    const thursday = new Date(date);
    thursday.setDate(date.getDate() + (day === 0 ? -3 : 4 - day));
    const year = thursday.getFullYear();
    const firstThursday = new Date(year, 0, 1);
    while (firstThursday.getDay() !== 4) firstThursday.setDate(firstThursday.getDate() + 1);
    const weekNum = Math.floor((thursday - firstThursday) / 86400000 / 7) + 1;
    return weekNum;
  }

  // timeline: always include full year 2026, but expand if tasks go outside
  function getTimelineRange() {
    const baseStart = new Date(2026, 0, 1);  // Jan 1 2026
    const baseEnd = new Date(2026, 11, 31); // Dec 31 2026

    let minStart = baseStart;
    let maxEnd = baseEnd;

    tasks.forEach(t => {
      if (t.start) {
        const ds = new Date(t.start);
        if (!isNaN(ds) && ds < minStart) minStart = ds;
      }
      if (t.due) {
        const de = new Date(t.due);
        if (!isNaN(de) && de > maxEnd) maxEnd = de;
      }
    });

    // extend to Monday of minStart week and Sunday of maxEnd week
    const startMonday = getMonday(minStart);
    const endMonday = getMonday(maxEnd);
    const endSunday = new Date(endMonday);
    endSunday.setDate(endSunday.getDate() + 6);

    return { start: startMonday, end: endSunday };
  }

  // generate weeks array from start to end (Monday each)
  function generateWeeks(startDate, endDate) {
    const weeks = [];
    const current = new Date(startDate);
    current.setHours(0,0,0,0);
    while (current <= endDate) {
      const weekStart = new Date(current);
      const weekNum = getWeekNumber(current);
      const month = current.toLocaleString('default', { month: 'short' });
      const year = current.getFullYear();
      weeks.push({ weekStart, weekNum, month, year });
      current.setDate(current.getDate() + 7);
    }
    return weeks;
  }

  // overlap check
  function overlapsWeek(task, weekStart) {
    if (!task.start || !task.due) return false;
    const ts = new Date(task.start); ts.setHours(0,0,0,0);
    const td = new Date(task.due); td.setHours(0,0,0,0);
    const we = new Date(weekStart); we.setDate(weekStart.getDate() + 6);
    return (ts <= we && td >= weekStart);
  }

  function getStatusClass(status) {
    switch(status) {
      case 'Not Started': return 'status-notstarted';
      case 'In Progress': return 'status-inprogress';
      case 'At Risk': return 'status-atrisk';
      case 'Blocked': return 'status-blocked';
      case 'Done': return 'status-done';
      default: return 'status-notstarted';
    }
  }
  function statusColor(status) {
    const map = {
      'Not Started':'#94a3b8','In Progress':'#2563eb','At Risk':'#dc2626','Blocked':'#ea580c','Done':'#16a34a'
    };
    return map[status] || '#94a3b8';
  }

  // escape
  function esc(s) { return (s??'').toString().replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

  // ---------- RENDER ----------
  function renderAll() {
    const range = getTimelineRange();
    const weeks = generateWeeks(range.start, range.end);

    // build header with month groups
    let headerHtml = '<tr>';
    // static headers
    headerHtml += '<th>#</th><th>Task</th><th>SFDC</th><th>Remark</th><th>Assigned</th><th>Start</th><th>Due</th><th>Dur</th><th>Progress</th><th>Status</th>';

    // group weeks by month/year for colspan
    const groups = [];
    weeks.forEach((w, idx) => {
      const last = groups[groups.length-1];
      if (!last || last.month !== w.month || last.year !== w.year) {
        groups.push({ month: w.month, year: w.year, count: 1, startIdx: idx });
      } else {
        last.count++;
      }
    });

    groups.forEach(g => {
      const monthClass = `month-${g.month.toLowerCase()}`;
      headerHtml += `<th colspan="${g.count}" class="month-header ${monthClass}">${g.month} ${g.year}</th>`;
    });
    headerHtml += '</tr><tr>';
    // second row for week numbers (empty static cells)
    headerHtml += '<th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th><th></th>';
    weeks.forEach(w => {
      headerHtml += `<th class="week-label">W${w.weekNum}</th>`;
    });
    headerHtml += '</tr>';
    document.getElementById('tableHeader').innerHTML = headerHtml;

    // update colgroup for week columns
    const colgroup = document.querySelector('colgroup');
    document.querySelectorAll('col.week-col').forEach(c => c.remove());
    for (let i=0; i<weeks.length; i++) {
      const col = document.createElement('col');
      col.className = 'week-col';
      colgroup.appendChild(col);
    }

    // render body
    let bodyHtml = '';
    tasks.forEach((t, idx) => {
      const start = t.start || '';
      const due = t.due || '';
      const duration = (t.start && t.due) ? Math.round((new Date(t.due) - new Date(t.start)) / 86400000) + 'd' : '';
      const statusClass = getStatusClass(t.status);
      const prog = Math.min(100, Math.max(0, Number(t.progress) || 0));
      const progressHtml = `<div class="progress-container"><div class="progress-bg"><div class="progress-fill" style="width:${prog}%;"></div></div><span class="progress-text">${prog}%</span></div>`;

      bodyHtml += `<tr data-id="${t.id}">`;
      // col1: item + icons
      bodyHtml += `<td class="item-icons"><span class="item-number">${idx+1}</span> <button class="icon-btn" onclick="editTask(${t.id})"><i class="fas fa-edit"></i></button> <button class="icon-btn" onclick="deleteTask(${t.id})"><i class="fas fa-trash-alt"></i></button></td>`;
      bodyHtml += `<td ondblclick="editTask(${t.id})">${esc(t.task)}</td>`;
      bodyHtml += `<td>${esc(t.sfdc)}</td>`;
      bodyHtml += `<td>${esc(t.remark)}</td>`;
      bodyHtml += `<td>${esc(t.assigned)}</td>`;
      bodyHtml += `<td>${start}</td><td>${due}</td><td>${duration}</td>`;
      bodyHtml += `<td>${progressHtml}</td>`;
      bodyHtml += `<td><span class="status-badge ${statusClass}">${t.status || 'Not Started'}</span></td>`;

      // Gantt cells
      weeks.forEach(w => {
        const overlap = overlapsWeek(t, w.weekStart);
        if (overlap) {
          const color = statusColor(t.status);
          bodyHtml += `<td class="week-cell"><div class="gantt-dot" style="background:${color};"></div></td>`;
        } else {
          bodyHtml += `<td class="week-cell"></td>`;
        }
      });
      bodyHtml += '</tr>';
    });
    if (!tasks.length) {
      bodyHtml += `<tr><td colspan="${10+weeks.length}" style="text-align:center; padding:40px;">No tasks. Click Add task.</td></tr>`;
    }
    document.getElementById('tableBody').innerHTML = bodyHtml;
  }

  // ---------- EDITOR ----------
  let currentEditId = null;
  window.editTask = function(id) {
    const task = tasks.find(t => t.id == id);
    if (task) {
      document.getElementById('editTask').value = task.task || '';
      document.getElementById('editSFDC').value = task.sfdc || '';
      document.getElementById('editRemark').value = task.remark || '';
      document.getElementById('editAssigned').value = task.assigned || '';
      document.getElementById('editStart').value = task.start || '';
      document.getElementById('editDue').value = task.due || '';
      document.getElementById('editProgress').value = task.progress || 0;
      document.getElementById('editStatus').value = task.status || 'Not Started';
      document.getElementById('modalTitle').innerText = '✏️ Edit task';
      currentEditId = task.id;
    } else {
      // new
      document.getElementById('editTask').value = '';
      document.getElementById('editSFDC').value = '';
      document.getElementById('editRemark').value = '';
      document.getElementById('editAssigned').value = '';
      const today = new Date().toISOString().slice(0,10);
      document.getElementById('editStart').value = '2026-01-01'; // default to 2026
      document.getElementById('editDue').value = '2026-02-01';
      document.getElementById('editProgress').value = 0;
      document.getElementById('editStatus').value = 'Not Started';
      document.getElementById('modalTitle').innerText = '➕ New task';
      currentEditId = null;
    }
    document.getElementById('editorModal').style.display = 'flex';
  };
  window.deleteTask = function(id) {
    if (confirm('Delete this task?')) {
      tasks = tasks.filter(t => t.id != id);
      saveTasks();
    }
  };
  // modal buttons
  document.getElementById('addTaskBtn').addEventListener('click', () => editTask(null));
  document.getElementById('modalCancel').addEventListener('click', ()=>{
    document.getElementById('editorModal').style.display = 'none';
  });
  document.getElementById('modalSave').addEventListener('click', ()=>{
    const taskData = {
      task: document.getElementById('editTask').value,
      sfdc: document.getElementById('editSFDC').value,
      remark: document.getElementById('editRemark').value,
      assigned: document.getElementById('editAssigned').value,
      start: document.getElementById('editStart').value,
      due: document.getElementById('editDue').value,
      progress: parseInt(document.getElementById('editProgress').value) || 0,
      status: document.getElementById('editStatus').value
    };
    if (!taskData.task) return alert('Task name required');
    if (currentEditId) {
      const idx = tasks.findIndex(t => t.id == currentEditId);
      if (idx >= 0) tasks[idx] = { ...tasks[idx], ...taskData, id: tasks[idx].id };
    } else {
      tasks.push({ ...taskData, id: Date.now() + Math.random() });
    }
    saveTasks();
    document.getElementById('editorModal').style.display = 'none';
  });
  document.getElementById('modalDelete').addEventListener('click', ()=>{
    if (currentEditId) {
      tasks = tasks.filter(t => t.id != currentEditId);
      saveTasks();
      document.getElementById('editorModal').style.display = 'none';
    }
  });

  // import/export
  document.getElementById('exportExcelBtn').addEventListener('click', ()=>{
    const wsData = [['Task','SFDC','Remark','Assigned','Start','Due','Progress','Status']];
    tasks.forEach(t => wsData.push([t.task, t.sfdc, t.remark, t.assigned, t.start, t.due, t.progress, t.status]));
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb, ws, 'Tasks');
    XLSX.writeFile(wb, 'gantt_export.xlsx');
  });

  document.getElementById('importFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      const data = new Uint8Array(ev.target.result);
      const wb = XLSX.read(data, { type: 'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });
      if (rows.length < 2) return;
      const newTasks = [];
      for (let i=1; i<rows.length; i++) {
        const r = rows[i];
        if (!r[0]) continue;
        newTasks.push({
          id: Date.now()+i+Math.random(),
          task: r[0] || '',
          sfdc: r[1] || '',
          remark: r[2] || '',
          assigned: r[3] || '',
          start: r[4] || '',
          due: r[5] || '',
          progress: Number(r[6]) || 0,
          status: r[7] || 'Not Started'
        });
      }
      if (newTasks.length) { tasks = newTasks; saveTasks(); }
    };
    reader.readAsArrayBuffer(file);
    e.target.value = '';
  });

  document.getElementById('exportPDFBtn').addEventListener('click', function() {
    const { jsPDF } = window.jspdf;
    const wrapper = document.getElementById('ganttWrapper');
    html2canvas(wrapper, { scale: 1.5, backgroundColor: '#fff' }).then(canvas => {
      const imgData = canvas.toDataURL('image/png');
      const pdf = new jsPDF({ orientation: 'landscape', unit: 'px', format: [canvas.width/2, canvas.height/2] });
      pdf.addImage(imgData, 'PNG', 10, 10, canvas.width/2-20, canvas.height/2-20);
      pdf.save('gantt.pdf');
    });
  });

  // initial load
  loadTasks();
  renderAll();
  window.addEventListener('storage', (e) => { if (e.key === STORAGE_KEY) { loadTasks(); renderAll(); } });
})();
</script>
</body>
</html>
